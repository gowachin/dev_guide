# Evolución del paquete: cambiar cosas en tu paquete {#evolution}

```{block, type="summaryblock"}
Este capítulo presenta nuestra guía para cambiar cosas en tu paquete: cambiar los nombres de los parámetros, cambiar los nombres de las funciones, eliminar funciones, e incluso retirar y archivar paquetes.

Este capítulo fue aportado inicialmente como nota técnica en el sitio web de rOpenSci por [Scott Chamberlain](https://github.com/sckott); puedes leer la versión original [aquí](https://ropensci.org/technotes/2017/01/05/package-evolution/)._
```

## Filosofía de los cambios

Todo el mundo es libre de tener su propia opinión sobre la libertad con la que se cambian los parámetros/funciones/etc. en una biblioteca; las normas sobre los cambios en los paquetes no se imponen en CRAN ni en ningún otro sitio. En general, a medida que una biblioteca se hace más madura, los cambios en los métodos orientados al usuario (es decir, las funciones exportadas en un paquete R) deberían ser muy raros. Las bibliotecas que son dependientes de muchas otras bibliotecas probablemente sean más cuidadosas con los cambios, y deberían serlo.

## El paquete del ciclo de vida

En este capítulo se presentan soluciones que no requieren el paquete ciclo de vida, pero que pueden resultarte útiles.
Te recomendamos [leer la documentación del ciclo de vida](https://lifecycle.r-lib.org/articles/stages.html).

## Parámetros: cambiar los nombres de los parámetros

A veces hay que cambiar los nombres de los parámetros por claridad, o por alguna otra razón.

Un posible enfoque es comprobar si los argumentos obsoletos no faltan, y dejar de proporcionar un mensaje significativo.

```r
foo_bar <- function(x, y) {
    si (!missing(x)) {
        stop("utiliza 'y' en lugar de 'x'")
    }
    y^2
}

foo_bar(x = 5)
#> Error en foo_bar(x = 5) : usa 'y' en lugar de 'x' 
```

Si quieres ser más útil, podrías emitir una advertencia pero tomar automáticamente la acción necesaria

```r
foo_bar <- function(x, y) {
    si (!missing(x)) {
        warning("utiliza 'y' en lugar de 'x'")
        y <- x
    }
    y^2
}

foo_bar(x = 5)
#> 25
```

Ten en cuenta el parámetro `...`. Si tu función tiene `...`y ya has eliminado un parámetro (llamémoslo `z`), un usuario puede tener un código más antiguo que utilice `z`. Cuando pasen `z`, no es un parámetro en la definición de la función, y es probable que se ignore silenciosamente -- no es lo que quieres. En su lugar, deja el argumento, lanzando un error si se utiliza.

## Funciones: cambiar los nombres de las funciones

Si tienes que cambiar el nombre de una función, hazlo gradualmente, como con cualquier otro cambio en tu paquete.

Digamos que tienes una función `foo`.

```r
foo <- función(x) x + 1
```

Pero quieres cambiar el nombre de la función a `bar`.

En lugar de cambiar simplemente el nombre de la función y `foo` deje de existir directamente, en la primera versión del paquete donde `bar` aparezca, haz un alias como

```r
#' foo - añadir 1 a un input
#' @exportar
foo <- function(x) x + 1

#' @export
#' @rdname foo
bar <- foo
```

Con la solución anterior, el usuario puede utilizar `foo()` o `bar()` -- cualquiera de los dos hará lo mismo, ya que son la misma función.

También es útil tener un mensaje, pero entonces sólo querrás lanzar ese mensaje cuando usen la función anterior, por ejemplo

```r
#' foo - añadir 1 a un input
#' @exportar
foo <- function(x) {
    warning("por favor, utiliza bar() en lugar de foo()", call. = FALSE)
    bar(x)
}

#' @exportar
#' @rdname foo
bar <- function(x) x + 1
```

Después de que los usuarios hayan utilizado la versión del paquete durante un tiempo (con `foo` y `bar`), en la siguiente versión puedes eliminar el antiguo nombre de la función (`foo`), y tener sólo `bar`.

```r
#' bar - añadir 1 a un input
#' @exportar
bar <- function(x) x + 1
```

## Funciones: obsoletas y caducas

Para eliminar una función de un paquete (digamos que el nombre de tu paquete es `helloworld`), puedes utilizar el siguiente protocolo

- Marca la función como obsoleta en la versión del paquete `x` (por ejemplo `v0.2.0`)

En la propia función, utiliza `.Deprecated()` para apuntar a la función de sustitución:

```r
foo <- function() {
    .Deprecated("bar")
```


}

````

Hay opciones en `.Deprecated` para especificar un nuevo nombre de función, así como un nuevo nombre de paquete, lo que tiene sentido cuando se mueven funciones a paquetes diferentes.

El mensaje que da `.Deprecated` es una advertencia, por lo que los usuarios pueden suprimirla con `suppressWarnings()` si lo desean.

Haz una página de manual para las funciones obsoletas como:

```r
#Funciones obsoletas en helloworld
#' 
#' Estas funciones aún funcionan pero serán eliminadas (obsoletas) en la próxima versión.
#' 
#' \itemize
#' \NCódigo del elemento{{enlace{foo}}: Esta función está obsoleta y se eliminará
#' será eliminada en la próxima versión de este paquete.
#' }
#' 
#' @name helloworld-deprecated
NULL
````

Esto crea una página de manual a la que los usuarios pueden acceder como ``?`helloworld-deprecated` `` y verán en el índice de documentación. Añade cualquier función a esta página según sea necesario, y quítala cuando una función pase a estar obsoleta (ver más abajo).

- En la próxima versión (`v0.3.0`) puedes hacer que la función sea defunct (es decir, que desaparezca completamente del paquete, excepto por una página man con una nota sobre ella).

En la propia función, utiliza `.Defunct()` como

```r
foo <- function() {
    .Defunct("bar")
}
```

Observa que el mensaje en `.Defunct` es un error para que la función se detenga mientras que `.Deprecated` utiliza una advertencia que permite que la función continúe.

Además, es bueno añadir `...` a todas las funciones defuncionales para que si los usuarios pasan algún parámetro obtengan el mismo mensaje defuncional en lugar de un `unused argument` mensaje, así como

```r
foo <- function(...) {
    .Defunct("bar")
}
```

Sin `...` da:

```r
foo(x = 5)
#> Error en foo(x = 5) : argumento no utilizado (x = 5)
```

Y con `...` da:

```r
foo(x = 5)
#> Error: 'foo' ha sido eliminado de este paquete
```

Haz una página de manual para las funciones difuntas como

```r
#' Funciones defectuosas en helloworld
#' 
#' Estas funciones han desaparecido, ya no están disponibles.
#' 
#' \itemize{
#' \NCódigo de elemento {enlace{foo}}: Esta función ha desaparecido.
#' }
#' 
#' @nombre de helloworld-defuncionado
NULL
```

Esto crea una página de manual a la que los usuarios pueden acceder como ``?`helloworld-defunct` `` y verán en el índice de documentación. Añade a esta página las funciones que necesites. Es probable que quieras mantener esta página man indefinidamente.

### Probar las funciones obsoletas

No es necesario que cambies los test de las funciones obsoletas hasta que dejen de estarlo.

- Ten en cuenta cualquier cambio realizado en una función obsoleta. Además de utilizar `.Deprecated` dentro de la función, ¿has cambiado los parámetros en la función obsoleta, o has creado una nueva función que sustituye a la función obsoleta, etc.? Hay que probar esos cambios, si se han hecho.
- En relación con lo anterior, si a la función obsoleta se le cambia simplemente el nombre, tal vez se pueda testar que las funciones antigua y nueva devuelven resultados idénticos.
- [`suppressWarnings()` podría utilizarse](https://community.rstudio.com/t/unit-testing-of-a-deprecated-function/42837/2) para suprimir la advertencia lanzada desde `.Deprecated`pero las pruebas no están orientadas al usuario, así que no es tan malo que la advertencia se lance en las pruebas, y la advertencia podría incluso utilizarse como recordatorio para el mantenedor.

Una vez que una función ha dejado de funcionar, sus tests se eliminan sin más.

## Archivar paquetes {#archivalguidance}

Por lo general, el software tiene una vida útil finita, y es posible que los paquetes deban ser archivados en algún momento. Los paquetes archivados son [archivados](https://docs.github.com/en/repositories/archiving-a-github-repository/archiving-repositories) y se trasladan a una organización dedicada de GitHub, [ropensci-archive](https://github.com/ropensci-archive). Antes de archivar, el contenido del archivo README debe trasladarse a una ubicación alternativa (como "README-OLD.md"), y sustituirse por un contenido mínimo que incluya algo como lo siguiente

```md
# <nombre del paquete>

[![Estado del proyecto: sin apoyo](https://www.repostatus.org/badges/latest/unsupported.svg)](https://www.repostatus.org/#unsupported)
[![Etiqueta de revisión por pares](https://badges.ropensci.org/<issue_number>_status.svg)](https://github.com/ropensci/software-review/issues/<issue_number>)

Este paquete ha sido archivado. El antiguo README está ahora en [README-viejo](<link-a-README-viejo>).
```

La etiqueta del estado del repositorio debe ser "no soportado" para los paquetes anteriormente liberados, o "abandonado" para los antiguos paquetes conceptuales o WIP, en cuyo caso el código de la etiqueta anterior debe sustituirse por:

```md
[![Estado del proyecto: Abandonado](https://www.repostatus.org/badges/latest/abandoned.svg)](https://www.repostatus.org/#abandoned)
```

Un ejemplo de un LÉAME mínimo en un paquete archivado está en [ropensci-archive/monkeylearn](https://github.com/ropensci-archive/monkeylearn/blob/master/README.md). Una vez que el LÉAME se ha copiado en otro lugar y se ha reducido a su forma mínima, hay que seguir los siguientes pasos

- [ ] Cierra los issues con una frase que explique la situación y enlace a esta guía.
- [ ] Archivar el repositorio en GitHub (también en la configuración del repositorio).
- [ ] Transfiere el repositorio a [ropensci-archive](https://github.com/ropensci-archive)o solicita a un [miembro del personal de rOpenSci](https://ropensci.org/about/#team) que lo transfiera (puedes enviar un correo electrónico a `info@ropensci.org`).

Los paquetes archivados pueden ser desarchivados si los autores o una nueva persona optan por reanudar el mantenimiento. Para ello, ponte en contacto con rOpenSci. Se transfieren a la organización ropenscilabs.


